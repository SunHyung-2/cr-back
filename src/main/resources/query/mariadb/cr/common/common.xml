<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.cra.common.mapper.CRACommonMapper">

    <!-- 환자 접수상태 변경 -->
    <update id="updateRcpnStat">
        UPDATE cbotrcinmv
           SET last_updt_usid = #{last_updt_usid}, last_uddt = #{last_uddt}, cbotrcinmv.rcpn_stat_cd = #{rcpn_stat_cd}
         WHERE cbotrcinmv.hspt_cd = #{hspt_cd}
           AND cbotrcinmv.pid = #{pid}
           AND cbotrcinmv.rcpn_sqno = #{rcpn_sqno}
    </update>

<!--    환자 검색       -->
    <select id="searchPtList" resultType="com.amaranth10.cr.cra.common.model.Patient">
        SELECT pid, pt_nm, sex_cd, dobr
        FROM cbptbainmt
        WHERE hspt_cd = #{hspt_cd}
          AND ( pid LIKE CONCAT('%', #{keyword}, '%')
                OR pt_nm LIKE CONCAT('%', #{keyword}, '%'))
    </select>

<!--    환자 접수 내역 목록     -->
    <select id="rcpnList" resultType="com.amaranth10.cr.cra.common.model.Reception">
        <if test='option == "1"'>
            SELECT rcpn_sqno,
                   DATE_FORMAT(mdcr_date, '%Y-%m-%d') As mdcr_date,
                   fn_get_username(hspt_cd, mdcr_dr_id) As mdcr_dr_id,
                   fn_get_deptname(hspt_cd, mdcr_date, mddp_cd) As mddp_cd,
                   fn_get_commname(hspt_cd, mdcr_date, 'CB4003', fvnr_dvcd) As fvnr_dvcd,
                   fn_get_commname(hspt_cd, mdcr_date, 'CB4005', insn_tycd) As insn_tycd
            FROM cbotrcinmv
            WHERE hspt_cd = #{hspt_cd}
              AND pid = #{pid}
              AND mdcr_date BETWEEN #{period.from} AND #{period.to}
            ORDER BY mdcr_date DESC
        </if>
        <if test='option == "2"'>
            SELECT cbotrcinmv.rcpn_sqno,
                    DATE_FORMAT(cbotrcinmv.mdcr_date, '%Y-%m-%d') As mdcr_date,
                    fn_get_username(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_dr_id) As mdcr_dr_id,
                    fn_get_deptname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, cbotrcinmv.mddp_cd) As mddp_cd,
                    fn_get_commname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, 'CB4003', cbotrcinmv.fvnr_dvcd) As fvnr_dvcd,
                    fn_get_commname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, 'CB4005', cbotrcinmv.insn_tycd) As insn_tycd
            FROM cbotrcinmv AS cbotrcinmv
            LEFT JOIN crexmprsnt As crexmprsnt
                   ON crexmprsnt.hspt_cd = #{hspt_cd}
                  AND crexmprsnt.rcpn_sqno = cbotrcinmv.rcpn_sqno
                  AND crexmprsnt.pid = #{pid}
            WHERE cbotrcinmv.hspt_cd = #{hspt_cd}
              AND cbotrcinmv.pid = #{pid}
              AND cbotrcinmv.mdcr_date BETWEEN #{period.from} AND #{period.to}
            UNION
            SELECT cbotrcinmv.rcpn_sqno,
                    DATE_FORMAT(cbotrcinmv.mdcr_date, '%Y-%m-%d') As mdcr_date,
                    fn_get_username(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_dr_id) As mdcr_dr_id,
                    fn_get_deptname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, cbotrcinmv.mddp_cd) As mddp_cd,
                    fn_get_commname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, 'CB4003', cbotrcinmv.fvnr_dvcd) As fvnr_dvcd,
                    fn_get_commname(cbotrcinmv.hspt_cd, cbotrcinmv.mdcr_date, 'CB4005', cbotrcinmv.insn_tycd) As insn_tycd
            FROM cbotrcinmv AS cbotrcinmv
            RIGHT JOIN crexmprsnt As crexmprsnt
                    ON crexmprsnt.hspt_cd = #{hspt_cd}
                   AND crexmprsnt.rcpn_sqno = cbotrcinmv.rcpn_sqno
                   AND crexmprsnt.pid = #{pid}
                   AND crexmprsnt.rcpn_dt BETWEEN #{period.from} AND #{period.to}
            WHERE cbotrcinmv.hspt_cd = #{hspt_cd}
            AND cbotrcinmv.pid = #{pid}
            ORDER BY mdcr_date DESC, rcpn_sqno DESC
        </if>
    </select>

<!--    진단 내역       -->
    <select id="pastDgns" resultType="com.amaranth10.cr.cra.common.model.Diagnosis">
        SELECT dgns_sqno,
               dgns_cd,
               dgns_nm,
               fn_get_commname(hspt_cd, inpt_dt, 'CR2001', dvsn) As dvsn
        FROM crptdgnsnt
        WHERE hspt_cd = #{hspt_cd}
          AND del_yn = "N"
          AND rcpn_sqno = #{rcpn_sqno}
          AND pid = #{pid}
        ORDER BY sort_sqno
    </select>

<!--    처방 내역       -->
    <select id="pastPrsc" resultType="com.amaranth10.cr.cra.common.model.Prescription">
        SELECT prsc_cd,
                prsc_nm,
                dosg_1,
                notm,
                nody,
                iotm_cd,
                mix_no,
                fn_get_commname(hspt_cd, mdcr_date, 'CB3001', prsc_pay_dvcd) As prsc_pay_dvcd,
                IF(hsin_hsot_dvcd = '-', '-', fn_get_commname(hspt_cd, mdcr_date, 'CR3003', hsin_hsot_dvcd)) As hsin_hsot_dvcd,
                prsc_prgr_stat_cd,
                rcpt_stat_cd,
                prsc_memo,
                jx999,
                dc_yn,
                dc_resn_cd,
                dc_resn
        FROM crprescpmv
        WHERE hspt_cd = #{hspt_cd}
          AND rcpn_sqno = #{rcpn_sqno}
          AND pid = #{pid}
        ORDER BY sort_sqno
    </select>
</mapper>