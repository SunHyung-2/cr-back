<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.cra.common.mapper.CRACommonMapper">
    <!-- 환자정보 조회 -->
    <select id="patientInfo" resultType="com.amaranth10.cr.cra.common.model.Patient">
        SELECT cbptbainmt.pid,
               cbptbainmt.pt_nm,
               cbptbainmt.sex_cd,
               CONCAT((TRUNCATE((TO_DAYS(NOW()) - TO_DAYS(DATE_FORMAT(cbptbainmt.dobr, '%Y-%m-%d'))) / 365, 0))) AS age,
               (SELECT count(*) FROM crinfinfnt WHERE pid = #{pid} AND del_yn = 'N') as inf_cnt,
               (SELECT alrg_info FROM cralginfnt WHERE pid = #{pid}) as alg_info
          FROM cbptbainmt
         WHERE cbptbainmt.hspt_cd = #{hspt_cd}
           AND cbptbainmt.pid = #{pid}
    </select>

    <!-- 감염리스트 조회 -->
    <select id="infList" resultType="java.util.HashMap">
        SELECT crkcddgcmt.cort_cmds_dvsn,
               crkcddgcmt.dgns_cd,
               crkcddgcmt.dgns_hnm
          FROM crkcddgcmt
         WHERE crkcddgcmt.hspt_cd = #{hspt_cd}
           AND crkcddgcmt.cort_cmds_dvsn != ''
         ORDER BY crkcddgcmt.dgns_cd
    </select>

    <!-- 환자감염정보 조회 -->
    <select id="patientInf" resultType="java.util.HashMap">
        SELECT crinfinfnt.frst_rgst_usid,
               crinfinfnt.frst_rgdt,
               crinfinfnt.cort_cmds_dvsn,
               crinfinfnt.dgns_cd,
               crinfinfnt.dgns_hnm,
               crinfinfnt.del_yn as stat
          FROM crinfinfnt
         WHERE crinfinfnt.hspt_cd = #{hspt_cd}
           AND crinfinfnt.pid = #{pid}
         ORDER BY crinfinfnt.frst_rgdt, crinfinfnt.dgns_cd
    </select>

    <!-- 환자감염정보 추가 -->
    <insert id="infInsert">
        INSERT INTO crinfinfnt
        (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt, pid, cort_cmds_dvsn, dgns_cd, dgns_hnm, del_yn)
        VALUES
        <foreach collection="insertList" item="item" separator=",">
            (#{hspt_cd}, #{frst_rgst_usid}, #{frst_rgdt}, #{last_updt_usid}, #{last_uddt}, #{pid}, #{item.cort_cmds_dvsn}, #{item.dgns_cd}, #{item.dgns_hnm}, 'N')
        </foreach>
    </insert>

    <!-- 환자감염정보 수정 -->
    <update id="infUpdate">
        UPDATE crinfinfnt
           SET crinfinfnt.last_updt_usid = #{last_updt_usid}, crinfinfnt.last_uddt = #{last_uddt}, crinfinfnt.del_yn = 'N'
         WHERE crinfinfnt.hspt_cd = #{hspt_cd}
           AND crinfinfnt.pid = #{pid}
           AND crinfinfnt.dgns_cd IN
        <foreach collection="updateList" item="item"  open="(" close=")" separator=",">
            #{item.dgns_cd}
        </foreach>
    </update>

    <!-- 환자감염정보 삭제 -->
    <update id="infDelete">
        UPDATE crinfinfnt
           SET crinfinfnt.last_updt_usid = #{last_updt_usid}, crinfinfnt.last_uddt = #{last_uddt}, crinfinfnt.del_yn = 'Y'
         WHERE crinfinfnt.hspt_cd = #{hspt_cd}
           AND crinfinfnt.pid = #{pid}
           AND crinfinfnt.dgns_cd IN
        <foreach collection="deleteList" item="item"  open="(" close=")" separator=",">
            #{item.dgns_cd}
        </foreach>
    </update>

    <!-- 환자알러지정보 조회 -->
    <select id="patientAlg" resultType="java.lang.String">
        SELECT cralginfnt.alrg_info
          FROM cralginfnt
         WHERE cralginfnt.hspt_cd = #{hspt_cd}
           AND cralginfnt.pid = #{pid}
    </select>

    <!-- 환자알러지정보 추가 -->
    <insert id="algInsert">
        INSERT INTO cralginfnt (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt, pid, alrg_info)
        VALUES (#{hspt_cd}, #{frst_rgst_usid}, #{frst_rgdt}, #{last_updt_usid}, #{last_uddt}, #{pid}, #{alrg_info})
    </insert>

    <!-- 환자알러지정보 수정 -->
    <update id="algUpdate">
        UPDATE cralginfnt
           SET cralginfnt.last_updt_usid = #{last_updt_usid}, cralginfnt.last_uddt = #{last_uddt}, cralginfnt.alrg_info = #{alrg_info}
         WHERE cralginfnt.hspt_cd = #{hspt_cd}
           AND cralginfnt.pid = #{pid}
    </update>

    <!-- 환자 접수상태 변경 -->
    <update id="updateRcpnStat">
        UPDATE cbotrcinnt
           SET cbotrcinnt.rcpn_stat_cd = #{rcpn_stat_cd}
         WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
           AND cbotrcinnt.pid = #{pid}
           AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
    </update>

<!--    환자 검색       -->
    <select id="searchPtList" resultType="com.amaranth10.cr.cra.common.model.Patient">
        SELECT pid, pt_nm, sex_cd, dobr
        FROM cbptbainmt
        WHERE hspt_cd = #{hspt_cd}
          AND ( pid LIKE CONCAT('%', #{keyword}, '%')
                OR pt_nm LIKE CONCAT('%', #{keyword}, '%'))
    </select>

<!--    환자 접수 내역 목록     -->
    <select id="rcpnList" resultType="com.amaranth10.cr.cra.common.model.Reception">
        <if test='option == "1"'>
            SELECT rcpn_sqno,
                   DATE_FORMAT(mdcr_date, '%Y-%m-%d') As mdcr_date,
                   fn_get_username(hspt_cd, mdcr_dr_id) As mdcr_dr_id,
                   fn_get_deptname(hspt_cd, mdcr_date, mddp_cd) As mddp_cd,
                   fn_get_commname(hspt_cd, mdcr_date, 'CB4003', fvnr_dvcd) As fvnr_dvcd,
                   fn_get_commname(hspt_cd, mdcr_date, 'CB4005', insn_tycd) As insn_tycd
            FROM cbotrcinnt
            WHERE hspt_cd = #{hspt_cd}
              AND pid = #{pid}
              AND mdcr_date BETWEEN #{period.from} AND #{period.to}
            ORDER BY mdcr_date DESC
        </if>
        <if test='option == "2"'>
            SELECT cbotrcinnt.rcpn_sqno,
                    DATE_FORMAT(cbotrcinnt.mdcr_date, '%Y-%m-%d') As mdcr_date,
                    fn_get_username(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_dr_id) As mdcr_dr_id,
                    fn_get_deptname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, cbotrcinnt.mddp_cd) As mddp_cd,
                    fn_get_commname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, 'CB4003', cbotrcinnt.fvnr_dvcd) As fvnr_dvcd,
                    fn_get_commname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, 'CB4005', cbotrcinnt.insn_tycd) As insn_tycd
            FROM cbotrcinnt AS cbotrcinnt
            LEFT JOIN crexmprsnt As crexmprsnt
                   ON crexmprsnt.hspt_cd = #{hspt_cd}
                  AND crexmprsnt.rcpn_sqno = cbotrcinnt.rcpn_sqno
                  AND crexmprsnt.pid = #{pid}
            WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
              AND cbotrcinnt.pid = #{pid}
              AND cbotrcinnt.mdcr_date BETWEEN #{period.from} AND #{period.to}
            UNION
            SELECT cbotrcinnt.rcpn_sqno,
                    DATE_FORMAT(cbotrcinnt.mdcr_date, '%Y-%m-%d') As mdcr_date,
                    fn_get_username(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_dr_id) As mdcr_dr_id,
                    fn_get_deptname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, cbotrcinnt.mddp_cd) As mddp_cd,
                    fn_get_commname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, 'CB4003', cbotrcinnt.fvnr_dvcd) As fvnr_dvcd,
                    fn_get_commname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, 'CB4005', cbotrcinnt.insn_tycd) As insn_tycd
            FROM cbotrcinnt AS cbotrcinnt
            RIGHT JOIN crexmprsnt As crexmprsnt
                    ON crexmprsnt.hspt_cd = #{hspt_cd}
                   AND crexmprsnt.rcpn_sqno = cbotrcinnt.rcpn_sqno
                   AND crexmprsnt.pid = #{pid}
                   AND crexmprsnt.rcpn_dt BETWEEN #{period.from} AND #{period.to}
            WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
            AND cbotrcinnt.pid = #{pid}
            ORDER BY mdcr_date DESC, rcpn_sqno DESC
        </if>
    </select>

<!--    진단 내역       -->
    <select id="pastDgns" resultType="com.amaranth10.cr.cra.common.model.Diagnosis">
        SELECT dgns_sqno,
               dgns_cd,
               dgns_nm,
               fn_get_commname(hspt_cd, inpt_dt, 'CR2001', dvsn) As dvsn
        FROM crptdgnsnt
        WHERE hspt_cd = #{hspt_cd}
          AND del_yn = "N"
          AND rcpn_sqno = #{rcpn_sqno}
          AND pid = #{pid}
        ORDER BY sort_sqno
    </select>

<!--    처방 내역       -->
    <select id="pastRcpn" resultType="com.amaranth10.cr.cra.common.model.Prescription">

    </select>
</mapper>