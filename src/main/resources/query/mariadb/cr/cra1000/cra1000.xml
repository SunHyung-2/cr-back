<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.cra.cra1000.mapper.CRA1000Mapper">

<!--    CLRS0101 환자현황 ==========================================================================================================================================-->
<!--    환자현황 진료의 목록 조회  -->
    <select id="doctList" resultType="java.util.HashMap">
        SELECT usid as value, user_nm as labelText
          FROM cli.cxusemngmt
         WHERE cxusemngmt.hspt_cd = #{hspt_cd}
           AND cxusemngmt.otpt_mdcr_dr_yn = 'Y'
           AND cxusemngmt.del_yn = 'N'
         ORDER BY user_nm
    </select>
<!--    환자현황 대기 환자수 조회  -->
    <select id="patientCount" resultType="java.util.HashMap">
        SELECT COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd IN ('R', 'M') THEN 1 END) AS Rcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd = 'W' THEN 1 END) AS Wcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd = 'V' THEN 1 END) AS Vcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd IN ('T', 'D') THEN 1 END) AS Dcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd LIKE '%' THEN 1 END) AS Acount
          FROM cli.cbotrcinnt
         WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
           AND cbotrcinnt.mdcr_date = #{mdcr_date}
           AND cbotrcinnt.mdcr_dr_id like #{mdcr_dr_id}
           AND cbotrcinnt.rcpn_stat_cd != 'C'
    </select>

<!--    환자현황 대기 리스트-->
    <select id="patientList" resultType="com.amaranth10.cr.cra.cra1000.model.Patient">
        SELECT cbptbainmt.pid,
               cbptbainmt.pt_nm,
               cbotrcinnt.mdcr_date,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4001', cbotrcinnt.rcpn_stat_cd) as rcpn_stat_cd,
               cbotrcinnt.mdcr_hm,
               cbotrcinnt.rcpn_sqno,
               cbotrcinnt.rcpn_stat_cd as call_patient
        FROM cli.cbptbainmt, cli.cbotrcinnt
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbotrcinnt.hspt_cd = cbptbainmt.hspt_cd
          AND cbotrcinnt.pid = cbptbainmt.pid
          AND cbotrcinnt.mdcr_date = #{mdcr_date}
          AND cbotrcinnt.rcpn_stat_cd IN (
        <foreach collection="rcpn_stat_list" item="item" separator=",">
            #{item}
        </foreach>)
          AND cbotrcinnt.mdcr_dr_id like #{mdcr_dr_id}
          AND cbotrcinnt.rcpn_stat_cd != 'C'
          AND cbptbainmt.del_yn = 'N'
        ORDER BY cbotrcinnt.mdcr_hm
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0102 환자정보 ==========================================================================================================================================-->
<!--    환자정보, 접수정보 조회      -->
    <select id="patientDetails" resultType="com.amaranth10.cr.cra.cra1000.model.Patient">
        SELECT cbptbainmt.pid,
               cbptbainmt.pt_nm,
               cbptbainmt.pt_frrn,
               cbptbainmt.pt_srrn,
               cbptbainmt.dobr,
               cbptbainmt.sex_cd As sex,
               cbptbainmt.cntc_tel,
               cbptbainmt.clph_no,
               cbptbainmt.pstl_no,
               cbptbainmt.basc_addr,
               cbptbainmt.detl_addr,
               cbptbainmt.vip_pt_yn,
               cbptbainmt.cncn_pt_yn,
               cbptbainmt.priv_pt_yn,
               cbotrcinnt.rcpn_sqno,
               cbotrcinnt.mdcr_date,
               cbotrcinnt.mdcr_hm,
               cbotrcinnt.mddp_cd,
               cbotrcinnt.mdcr_dr_id,
               cbotrcinnt.fvnr_dvcd,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4003', cbotrcinnt.fvnr_dvcd) As fvnr_dvcd_nm,
               cbotrcinnt.insn_tycd,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4005', cbotrcinnt.insn_tycd) As insn_tycd_nm,
               cbotrcinnt.type_asst_cd,
        cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4010', cbotrcinnt.type_asst_cd) As type_asst_cd_nm,
               cbotrcinnt.rcpn_memo,
               cbotrcinnt.cmhs_path_cd,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4004', cbotrcinnt.cmhs_path_cd) As cmhs_path_cd_nm,
               cbptmeinnt1.memo_dvsn As clr_dvsn,
               cbptmeinnt1.memo_cnts As clr_cnts,
               cbptmeinnt2.memo_dvsn As pat_dvsn,
               cbptmeinnt2.memo_cnts As pat_cnts
        FROM cli.cbptbainmt, cli.cbotrcinnt
        LEFT OUTER JOIN cli.cbptmeinnt As cbptmeinnt1
          ON cbptmeinnt1.hspt_cd = #{hspt_cd}
         AND cbptmeinnt1.pid = #{pid}
         AND cbptmeinnt1.memo_dvsn = 'CLR'
        LEFT OUTER JOIN cli.cbptmeinnt As cbptmeinnt2
          ON cbptmeinnt2.hspt_cd = #{hspt_cd}
         AND cbptmeinnt2.pid = #{pid}
         AND cbptmeinnt2.memo_dvsn = 'PAT'
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbptbainmt.hspt_cd = cbotrcinnt.hspt_cd
          AND cbotrcinnt.pid = #{pid}
          AND cbptbainmt.pid = cbotrcinnt.pid
          AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
    </select>

<!--    관심환자 여부 수정     -->
    <update id="updatePtCncn">
        UPDATE cli.cbptbainmt
           SET cbptbainmt.cncn_pt_yn = #{cncn_pt_yn}
        WHERE cbptbainmt.hspt_cd = #{hspt_cd}
          AND cbptbainmt.pid = #{pid}
    </update>

<!--    접수메모 저장 및 수정    -->
    <update id="patientRcpnMemo">
        UPDATE cli.cbotrcinnt
           SET cbotrcinnt.rcpn_memo = #{rcpn_memo}
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbotrcinnt.pid = #{pid}
          AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
    </update>

<!--    진료메모 & 환자메모 저장      -->
    <insert id="saveClrPtMemo">
        INSERT INTO cli.cbptmeinnt (hspt_cd, frst_rgst_usid, last_updt_usid, pid, memo_dvsn, memo_cnts)
        VALUES (#{hspt_cd}, #{usid}, #{usid}, #{pid}, #{memo_dvsn}, #{memo_cnts})
    </insert>
<!--    진료메모 & 환자메모 수정      -->
    <update id="updateClrPtMemo">
        UPDATE cli.cbptmeinnt
        SET last_updt_usid = #{usid},
            last_uddt = #{date},
            memo_cnts = #{memo_cnts}
        WHERE cbptmeinnt.hspt_cd = #{hspt_cd}
          AND cbptmeinnt.pid = #{pid}
          AND cbptmeinnt.memo_dvsn = #{memo_dvsn}
    </update>

<!--    환자정보, 접수정보 수정     -->
    <update id="updatePtRcpn">
        UPDATE cli.cbptbainmt As cbptbainmt
        JOIN cli.cbotrcinnt As cbotrcinnt
          ON cbptbainmt.hspt_cd = #{hspt_cd}
         AND cbotrcinnt.hspt_cd = cbptbainmt.hspt_cd
         AND cbptbainmt.pid = #{pid}
         AND cbotrcinnt.pid = cbptbainmt.pid
         AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
        SET cbptbainmt.last_updt_usid = #{usid},
            cbptbainmt.last_uddt = #{date},
            cbptbainmt.cntc_tel = #{cntc_tel},
            cbptbainmt.clph_no = #{clph_no},
            cbptbainmt.pstl_no = #{pstl_no},
            cbptbainmt.basc_addr = #{basc_addr},
            cbptbainmt.detl_addr = #{detl_addr},
            cbptbainmt.vip_pt_yn = #{vip_pt_yn},
            cbptbainmt.priv_pt_yn = #{priv_pt_yn},
            cbotrcinnt.last_updt_usid = #{usid},
            cbotrcinnt.last_uddt = #{date},
            cbotrcinnt.mdcr_date = #{mdcr_date},
            cbotrcinnt.mdcr_hm = #{mdcr_hm},
            cbotrcinnt.mddp_cd = #{mddp_cd},
            cbotrcinnt.mdcr_dr_id = #{mdcr_dr_id},
            cbotrcinnt.fvnr_dvcd = #{fvnr_dvcd},
            cbotrcinnt.insn_tycd = #{insn_tycd},
            cbotrcinnt.cmhs_path_cd = #{cmhs_path_cd}
    </update>

<!--    보험 구분 목록   -->
    <select id="insnList" resultType="java.util.HashMap">
        SELECT czcomcodmt.cmcd_cd As value,
               czcomcodmt.cmcd_nm As text
        FROM cli.czcomcodmt
        WHERE czcomcodmt.hspt_cd = #{hspt_cd}
          AND czcomcodmt.cmcd_clsf_cd = 'CB4005'
        ORDER BY czcomcodmt.cmcd_cd
    </select>

<!--    초재진 구분 목록   -->
    <select id="fvnrList" resultType="java.util.HashMap">
        SELECT czcomcodmt.cmcd_cd As value,
               czcomcodmt.cmcd_nm As text
        FROM cli.czcomcodmt
        WHERE czcomcodmt.hspt_cd = #{hspt_cd}
          AND czcomcodmt.cmcd_clsf_cd = 'CB4003'
        ORDER BY czcomcodmt.cmcd_cd
    </select>

<!--    부서 목록    -->
    <select id="depList" resultType="java.util.HashMap">
        SELECT dept_cd As value,
               dept_hnm As text
        FROM cli.cxdepinfmt
        WHERE hspt_cd = #{hspt_cd}
        ORDER BY dept_hnm
    </select>

    <!--    외래경로 목록     -->
    <select id="pathList" resultType="java.util.HashMap">
        SELECT czcomcodmt.cmcd_cd As value,
               czcomcodmt.cmcd_nm As text
        FROM cli.czcomcodmt
        WHERE czcomcodmt.hspt_cd = #{hspt_cd}
          AND czcomcodmt.cmcd_clsf_cd = 'CB4004'
        ORDER BY czcomcodmt.cmcd_cd
    </select>

<!--    내원목적 목록     -->
    <select id="prpsList" resultType="java.util.HashMap">
        SELECT czcomcodmt.cmcd_cd As value,
               czcomcodmt.cmcd_nm As text
        FROM cli.czcomcodmt
        WHERE czcomcodmt.hspt_cd = #{hspt_cd}
          AND czcomcodmt.cmcd_clsf_cd = 'CB4009'
        ORDER BY czcomcodmt.cmcd_cd
    </select>

<!--    ==========================================================================================================================================================-->

<!--    CLRS0103 신체사정정보 =======================================================================================================================================-->
<!--    신체사정정보 조회-->
    <select id="vitalData" resultType="com.amaranth10.cr.cra.cra1000.model.Vital">
        SELECT DATE_FORMAT(inpt_dt, '%Y-%m-%d %H:%i') AS inpt_dt,
        hght,
        wght,
        fbs,
        pr,
        rr,
        bt,
        sbp,
        dbp,
        sqno
        FROM cli.crvitlsgnt
        WHERE crvitlsgnt.hspt_cd = #{hspt_cd}
        AND crvitlsgnt.pid = #{pid}
        ORDER BY inpt_dt DESC
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0104 검사결과 ==========================================================================================================================================-->
<!--    검사결과 조회-->
    <select id="examResult" resultType="com.amaranth10.cr.cra.cra1000.model.Exam">
        SELECT DATE_FORMAT(csexmrelnt.exmn_date, '%Y-%m-%d') AS exmn_date,
               csexmrelnt.prsc_prgr_stat_cd,
               csexmrelnt.exmn_cd,
               crprsccdmt.prsc_nm,
               csexmrelnt.exmn_rslt1,
               csexmrelnt.nots_low,
               csexmrelnt.nots_high,
               csexmrelnt.prsc_sqno
          FROM cli.csexmrelnt, cli.crprsccdmt
         WHERE csexmrelnt.hspt_cd = #{hspt_cd}
           AND csexmrelnt.pid = #{pid}
           AND csexmrelnt.exmn_cd = crprsccdmt.prsc_cd
         ORDER BY csexmrelnt.prsc_sqno DESC
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0105 경과기록 ==========================================================================================================================================-->
<!--    경과기록 리스트 조회-->
    <select id="progressList" resultType="java.util.HashMap">
        SELECT cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4003', cbotrcinnt.fvnr_dvcd) as fvnr_dvnm,
               cbotrcinnt.fvnr_dvcd,
               DATE_FORMAT(crprogrsnt.inpt_dt,'%Y-%m-%d') AS inpt_dt,
               crprogrsnt.rcpn_sqno,
               crprogrsnt.prgr_sqno
          FROM cli.crprogrsnt, cli.cbotrcinnt
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.del_yn = 'N'
           AND crprogrsnt.hspt_cd = cbotrcinnt.hspt_cd
           AND crprogrsnt.pid = cbotrcinnt.pid
           AND crprogrsnt.rcpn_sqno = cbotrcinnt.rcpn_sqno
         ORDER BY cbotrcinnt.mdcr_date DESC, crprogrsnt.prgr_sqno desc
    </select>

<!--    경과기록 기본형 데이터 조회-->
    <select id="progressData" resultType="java.lang.String">
        SELECT IFNULL(prgr_rcrd, '')
          FROM cli.crprogrsnt
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.rcpn_sqno = #{rcpn_sqno}
           AND crprogrsnt.prgr_sqno = #{prgr_sqno}
           AND crprogrsnt.del_yn = 'N'
    </select>

<!--    경과기록 SOAP 데이터 조회-->
    <select id="progressSOAPData" resultType="java.util.HashMap">
        SELECT sbjt_cnts, objt_cnts, asss_cnts, plan
          FROM cli.crprogrsnt
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.rcpn_sqno = #{rcpn_sqno}
           AND crprogrsnt.prgr_sqno = #{prgr_sqno}
           AND crprogrsnt.del_yn = 'N'
    </select>

<!--    경과기록 일련번호 체크-->
    <select id="prgrSqnoCheck" resultType="java.lang.Integer">
        SELECT IFNULL(MAX(prgr_sqno) + 1, 1)
          FROM cli.crprogrsnt
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.rcpn_sqno = #{rcpn_sqno}
    </select>

<!--    경과기록 추가-->
    <insert id="progressInsert">
        INSERT INTO cli.crprogrsnt (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt, pid, inpt_dt, rcpn_sqno, prgr_sqno, del_yn)
        VALUES (#{hspt_cd}, #{frst_rgst_usid}, #{frst_rgdt}, #{last_updt_usid}, #{last_uddt}, #{pid}, #{inpt_dt}, #{rcpn_sqno}, #{prgr_sqno}, 'N')
    </insert>

<!--    경과기록 수정-->
    <update id="progressUpdate">
        UPDATE cli.crprogrsnt
           SET last_updt_usid = #{last_updt_usid}, last_uddt = #{last_uddt}, prgr_rcrd = #{prgr_rcrd},
               sbjt_cnts = #{sbjt_cnts}, objt_cnts = #{objt_cnts}, asss_cnts = #{asss_cnts}, plan = #{plan}
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.rcpn_sqno = #{rcpn_sqno}
           AND crprogrsnt.prgr_sqno = #{prgr_sqno}
    </update>

<!--    경과기록 삭제-->
    <update id="progressDelete">
        UPDATE cli.crprogrsnt
           SET crprogrsnt.last_updt_usid = #{last_updt_usid}, crprogrsnt.last_uddt = #{last_uddt}, crprogrsnt.del_yn = 'Y'
         WHERE crprogrsnt.hspt_cd = #{hspt_cd}
           AND crprogrsnt.pid = #{pid}
           AND crprogrsnt.rcpn_sqno = #{rcpn_sqno}
           AND crprogrsnt.prgr_sqno = #{prgr_sqno}
    </update>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0106 처방조회 ==========================================================================================================================================-->
<!--    과거기록 조회     -->
    <select id="pastList" resultType="com.amaranth10.cr.cra.cra1000.model.Reception">
        SELECT cbotrcinnt.rcpn_sqno,
               DATE_FORMAT(mdcr_date, '%Y-%m-%d') AS mdcr_date,
               cli.fn_get_username(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_dr_id, cbotrcinnt.mddp_cd) As mdcr_dr_id,
               cli.fn_get_deptname(cbotrcinnt.hspt_cd, cbotrcinnt.mdcr_date, cbotrcinnt.mddp_cd) As mddp_cd,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4003', cbotrcinnt.fvnr_dvcd) As fvnr_dvcd,
               cli.fn_get_commname(cbotrcinnt.mdcr_date, 'CB4005', cbotrcinnt.insn_tycd) As insn_tycd
        FROM cli.cbotrcinnt
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbotrcinnt.pid = #{pid}
        ORDER BY cbotrcinnt.mdcr_date DESC
    </select>

<!--    SLIP 목록     -->
    <select id="slipList" resultType="com.amaranth10.cr.cra.cra1000.model.Slip">
        SELECT crslipclmt.slip_cd,
               crslipclmt.slip_nm,
               crslipclmt.clsf_dvcd
        FROM cli.crslipclmt
        WHERE crslipclmt.hspt_cd = #{hspt_cd}
        ORDER BY crslipclmt.slip_cd
    </select>

<!--    SLIP 수가 항목      -->
    <select id="slipPrscList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crprsccdmt.prsc_cd,
               crprsccdmt.prsc_nm
        FROM cli.crprsccdmt
        WHERE crprsccdmt.hspt_cd = #{hspt_cd}
        AND crprsccdmt.slip_cd = #{slip_cd}
        AND crprsccdmt.prsc_psbl_yn = "Y"
        ORDER BY crprsccdmt.prsc_nm
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0107 진단 ==========================================================================================================================================-->
<!--    진단 검색       -->
    <select id="dgnsMList" resultType="com.amaranth10.cr.cra.cra1000.model.Diagnosis">
        SELECT crkcddgcmt.dgns_cd,
               crkcddgcmt.dgns_hnm As dgns_nm,
               crkcddgcmt.dgns_enm,
               crkcddgcmt.spcf_rgno
        FROM cli.crkcddgcmt
        WHERE crkcddgcmt.hspt_cd = #{hspt_cd}
          and (crkcddgcmt.dgns_cd LIKE CONCAT("%", #{keyword}, "%")
            OR crkcddgcmt.dgns_enm LIKE CONCAT("%", #{keyword}, "%")
            OR crkcddgcmt.dgns_hnm LIKE CONCAT("%", #{keyword}, "%"))
    </select>

<!--    진단 내역       -->
    <select id="dgnsList" resultType="com.amaranth10.cr.cra.cra1000.model.Diagnosis">
        SELECT crptdgnsnt.dgns_sqno,
               crptdgnsnt.dgns_cd,
               crptdgnsnt.dgns_nm,
               crptdgnsnt.dvsn,
               IF(crptdgnsnt.ro_yn = "Y", "True", "False") As ro_yn,
               crptdgnsnt.site_dvcd,
               crptdgnsnt.spcf_rgno,
               crptdgnsnt.hspt_cd,
               crptdgnsnt.rcpn_sqno
        FROM cli.crptdgnsnt
        WHERE crptdgnsnt.hspt_cd = #{hspt_cd}
          AND crptdgnsnt.del_yn = "N"
          AND crptdgnsnt.rcpn_sqno = #{rcpn_sqno}
          AND crptdgnsnt.pid = #{pid}
        ORDER BY crptdgnsnt.sort_sqno
    </select>

<!--    진단 저장       -->
    <insert id="savePtDgns" parameterType="java.util.Objects">
        <foreach item="item" collection="dgnsList" separator=";">
            INSERT INTO cli.crptdgnsnt
            SELECT
                #{item.hspt_cd},
                #{item.usid},
                #{item.dateTime},
                #{item.usid},
                #{item.dateTime},
                #{item.pid},
                #{item.rcpn_sqno},
                IFNULL(MAX(crptdgnsnt.dgns_sqno) + 1, 1),
                #{item.date},
                #{item.mddp_cd},
                #{item.usid},
                #{item.dgns_cd},
                #{item.dgns_nm},
                #{item.dvsn},
                <choose>
                    <when test='item.ro_yn == "True"'>'Y',</when>
                    <otherwise>'N',</otherwise>
                </choose>
                #{item.site_dvcd},
                #{item.spcf_rqno},
                'N',
                #{item.row}
            FROM cli.crptdgnsnt
            WHERE crptdgnsnt.hspt_cd = #{item.hspt_cd}
              AND crptdgnsnt.rcpn_sqno = #{item.rcpn_sqno}
              AND crptdgnsnt.pid = #{item.pid}
        </foreach>
    </insert>

<!--    진단 수정       -->
    <update id="updatePtDgns" parameterType="com.amaranth10.cr.cra.cra1000.model.Diagnosis">
        <if test="updateList != null and updateList.size != 0">
            <foreach collection="updateList" item="item" index="index" separator=";">
                <if test='item.dgns_sqno != null and !item.dgns_sqno.equals("")'>
                    UPDATE cli.crptdgnsnt
                    SET crptdgnsnt.last_updt_usid = #{item.usid},
                        crptdgnsnt.last_uddt = #{item.dateTime},
                        crptdgnsnt.dvsn = #{item.dvsn},
                        crptdgnsnt.ro_yn =
                            <choose>
                                <when test='item.ro_yn == "True"'>'Y',</when>
                                <otherwise>'N',</otherwise>
                            </choose>
                        crptdgnsnt.dgns_nm = #{item.dgns_nm},
                        crptdgnsnt.site_dvcd = #{item.site_dvcd},
                        crptdgnsnt.spcf_rgno = #{item.spcf_rgno},
                        crptdgnsnt.sort_sqno = #{item.row}
                    WHERE crptdgnsnt.hspt_cd = #{item.hspt_cd}
                      AND crptdgnsnt.rcpn_sqno = #{item.rcpn_sqno}
                      AND crptdgnsnt.dgns_sqno = #{item.dgns_sqno}
                </if>
            </foreach>
        </if>
        <if test="delList != null and delList.size != 0">
            <foreach collection="delList" item="item">
                UPDATE cli.crptdgnsnt
                   SET crptdgnsnt.del_yn = 'Y'
                WHERE crptdgnsnt.hspt_cd = #{item.hspt_cd}
                  AND crptdgnsnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND crptdgnsnt.dgns_sqno = #{item.dgns_sqno}
            </foreach>
        </if>
    </update>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0108 처방 ==========================================================================================================================================-->
<!--    처방 검색       -->
    <select id="prscMList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crprsccdmt.prsc_cd,
               crprsccdmt.prsc_nm,
               crprsccdmt.prsc_clsf_cd,
               crprsccdmt.slip_cd,
               crprsccdmt.drug_injc_dvsn,
               crprsccdmt.iotm_cd,
               crprsccdmt.inpy_dvcd,
               crprsccdmt.basc_dosg As dosg_1,
               crprsccdmt.basc_notm As notm,
<!--        crprsccdmt.prsc_psbl_yn,-->
               crprsccdmt.basc_aomd_uncd,
               crprsccdmt.spcm_cd_1,
               crprsccdmt.exrm_cd,
               crprsccdmt.hsot_prsc_yn As hsin_hsot_dvcd,
               crprsccdmt.spfm_excp_cd As hsin_prsc_resn_cd,
               crprsccdmt.ctnt_uncd As uncd,
               crprsccdmt.exmn_rslt_uncd
        FROM cli_dev.crprsccdmt
        WHERE crprsccdmt.hspt_cd = #{hspt_cd}
          AND crprsccdmt.prsc_psbl_yn = "Y"
          AND (crprsccdmt.prsc_cd LIKE CONCAT("%", #{keyword}, "%")
            OR crprsccdmt.prsc_nm LIKE CONCAT("%", #{keyword}, "%"))
    </select>

<!--    처방 내역       -->
    <select id="prscList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crdrinprnt.prsc_sqno,
                crdrinprnt.prsc_cd,
                crdrinprnt.prsc_nm,
                crdrinprnt.prsc_clsf_cd,
                crdrinprnt.dosg_1,
                crdrinprnt.notm,
                crdrinprnt.nody,
                crdrinprnt.drug_injc_dvsn,
                crdrinprnt.iotm_cd,
                crdrinprnt.pwdr_yn,
                crdrinprnt.mix_no,
                crdrinprnt.prsc_pay_dvcd As inpy_dvcd,
                crdrinprnt.hsin_hsot_dvcd,
                crdrinprnt.hsin_prsc_resn_cd,
                crdrinprnt.cmpt_yn,
                crdrinprnt.prsc_memo,
                crdrinprnt.jx999,
                crdrinprnt.dc_yn,
                crdrinprnt.dc_resn_cd,
                crdrinprnt.dc_resn
        FROM cli.crdrinprnt
        WHERE crdrinprnt.hspt_cd = #{hspt_cd}
          AND crdrinprnt.rcpn_sqno = #{rcpn_sqno}
          AND crdrinprnt.pid = #{pid}
        ORDER BY crdrinprnt.sort_sqno
    </select>

<!--    처방 저장       -->
    <update id="savePtPrsc">
        <foreach collection="prscList" item="item" separator=";" index="index">
            <!-- 기본 처방 -->
            <if test='item.prsc_clsf_cd == "A1" or item.prsc_clsf_cd == "A2" or item.prsc_clsf_cd == "A3"'>
                INSERT INTO cli.crbasprsnt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                    pid, prsc_date, prsc_sqno, prsc_cd, prsc_nm, rcpn_sqno, prsc_clsf_cd, slip_cd,
                    mdcr_date, mdcr_hm, mddp_cd, mdcr_dr_id, prsc_dr_id, prsc_inpt_dt, insn_tycd, type_asst_cd,
                    sort_sqno, cmpt_yn, prsc_memo, jx999, dc_yn)
                SELECT
                    #{item.hspt_cd},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.pid},
                    #{item.date},
                    IFNULL(MAX(crbasprsnt.prsc_sqno) + 1, 1),
                    #{item.prsc_cd},
                    #{item.prsc_nm},
                    #{item.rcpn_sqno},
                    #{item.prsc_clsf_cd},
                    #{item.slip_cd},
                    cbotrcinnt.mdcr_date,
                    cbotrcinnt.mdcr_hm,
                    #{item.mddp_cd},
                    #{item.usid},
                    #{item.usid},
                    #{item.dateTime},
                cbotrcinnt.insn_tycd,
                cbotrcinnt.type_asst_cd,
                    #{item.row},
                    #{item.cmpt_yn},
                    #{item.prsc_memo},
                    #{item.jx999},
                    'N'
                FROM cli.crbasprsnt, cli.cbotrcinnt
                WHERE crbasprsnt.hspt_cd = #{item.hspt_cd}
                  AND crbasprsnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND crbasprsnt.pid = #{item.pid}
                  AND cbotrcinnt.hspt_cd = #{item.hspt_cd}
                  AND cbotrcinnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND cbotrcinnt.pid = #{item.pid}
            </if>
            <!-- 약주사 처방 -->
            <if test='item.prsc_clsf_cd == "B1" or item.prsc_clsf_cd == "B2" or item.prsc_clsf_cd == "B3" or item.prsc_clsf_cd == "B4"'>
                INSERT INTO cli.crdrinprnt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                    pid, prsc_date, prsc_sqno, prsc_cd, prsc_nm, rcpn_sqno, prsc_clsf_cd, slip_cd,
                    mdcr_date, mdcr_hm, mddp_cd, mdcr_dr_id, prsc_dr_id, prsc_inpt_dt, insn_tycd,
                    sort_sqno, cmpt_yn, prsc_memo, jx999, dc_yn,
                    dosg_1, uncd, totl_vol, notm, nody, drug_injc_dvsn,
                    iotm_cd, prsc_pay_dvcd, pwdr_yn, mix_yn, mix_no,
                    hsin_hsot_dvcd, hsin_prsc_resn_cd
                )
                SELECT
                    #{item.hspt_cd},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.pid},
                    #{item.date},
                    IFNULL(MAX(crdrinprnt.prsc_sqno) + 1, 1),
                    #{item.prsc_cd},
                    #{item.prsc_nm},
                    #{item.rcpn_sqno},
                    #{item.prsc_clsf_cd},
                    #{item.slip_cd},
                    cbotrcinnt.mdcr_date,
                    cbotrcinnt.mdcr_hm,
                    #{item.mddp_cd},
                    #{item.usid},
                    #{item.usid},
                    #{item.dateTiem},
                cbotrcinnt.insn_tycd,
                    #{item.row},
                    #{item.cmpt_yn},
                    #{item.prsc_memo},
                    #{item.jx999},
                    'N',
                    #{item.dosg_1},
                    #{item.uncd},
                    #{item.totl_vol},
                    #{item.notm},
                    #{item.nody},
                    #{item.drug_injc_dvsn},
                    #{item.iotm_cd},
                    #{item.inpy_dvcd},
                    #{item.pwdr_yn},
                    #{item.mix_yn},
                    #{item.mix_no},
                    #{item.hsin_hsot_dvcd},
                    #{item.hsin_prsc_resn_cd}
                FROM cli.crdrinprnt, cli.cbotrcinnt
                WHERE crdrinprnt.hspt_cd = #{item.hspt_cd}
                  AND crdrinprnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND crdrinprnt.pid = #{item.pid}
                  AND cbotrcinnt.hspt_cd = #{item.hspt_cd}
                  AND cbotrcinnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND cbotrcinnt.pid = #{item.pid}
            </if>
            <!-- 검사 처방 -->
            <if test='item.prsc_clsf_cd == "C1" or item.prsc_clsf_cd == "C2" or item.prsc_clsf_cd == "C3"'>
                INSERT INTO cli.crexmprsnt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                    pid, prsc_date, prsc_sqno, prsc_cd, prsc_nm, rcpn_sqno, prsc_clsf_cd, slip_cd,
                    mdcr_date, mdcr_hm, mddp_cd, mdcr_dr_id, prsc_dr_id, prsc_inpt_dt, insn_tycd, type_asst_cd,
                    sort_sqno, cmpt_yn, prsc_memo, jx999, dc_yn,
                    spcm_cd_1, hope_exrm_cd
                )
                SELECT
                    #{item.hspt_cd},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.pid},
                    #{item.date},
                    IFNULL(MAX(crexmprsnt.prsc_sqno) + 1, 1),
                    #{item.prsc_cd},
                    #{item.prsc_nm},
                    #{item.rcpn_sqno},
                    #{item.prsc_clsf_cd},
                    #{item.slip_cd},
                    cbotrcinnt.mdcr_date,
                    cbotrcinnt.mdcr_hm,
                    #{item.mddp_cd},
                    #{item.usid},
                    #{item.usid},
                    #{item.dateTime},
                cbotrcinnt.insn_tycd,
                cbotrcinnt.type_asst_cd,
                    #{item.row},
                    #{item.cmpt_yn},
                    #{item.prsc_memo},
                    #{item.jx999},
                    'N',
                    #{item.spcm_cd_1},
                    #{item.exrm_cd}
                FROM cli.crexmprsnt, cli.cbotrcinnt
                WHERE crexmprsnt.hspt_cd = #{item.hspt_cd}
                  AND crexmprsnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND crexmprsnt.pid = #{item.pid}
                  AND cbotrcinnt.hspt_cd = #{item.hspt_cd}
                  AND cbotrcinnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND cbotrcinnt.pid = #{item.pid}
            </if>
            <!-- 처치 처방 -->
            <if test='item.prsc_clsf_cd == "D" or item.prsc_clsf_cd == "D1" or item.prsc_clsf_cd == "D2" or item.prsc_clsf_cd == "D3" or item.prsc_clsf_cd == "D4" or item.prsc_clsf_cd == "D5"'>
                INSERT INTO cli.crtrtprsnt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                    pid, prsc_date, prsc_sqno, prsc_cd, prsc_nm, rcpn_sqno, prsc_clsf_cd, slip_cd,
                    mdcr_date, mdcr_hm, mddp_cd, mdcr_dr_id, prsc_dr_id, prsc_inpt_dt, insn_tycd, type_asst_cd,
                    sort_sqno, cmpt_yn, prsc_memo, jx999, dc_yn,
                    qty, notm, uncd
                )
                SELECT
                    #{item.hspt_cd},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.usid},
                    #{item.dateTime},
                    #{item.pid},
                    #{item.date},
                    IFNULL(MAX(crtrtprsnt.prsc_sqno) + 1, 1),
                    #{item.prsc_cd},
                    #{item.prsc_nm},
                    #{item.rcpn_sqno},
                    #{item.prsc_clsf_cd},
                    #{item.slip_cd},
                    cbotrcinnt.mdcr_date,
                    cbotrcinnt.mdcr_hm,
                    #{item.mddp_cd},
                    #{item.usid},
                    #{item.usid},
                    #{item.dateTime},
                cbotrcinnt.insn_tycd,
                cbotrcinnt.type_asst_cd,
                    #{item.row},
                    #{item.cmpt_yn},
                    #{item.prsc_memo},
                    #{item.jx999},
                    'N',
                    #{item.dosg_1},
                    #{item.notm},
                    #{item.uncd}
                FROM cli.crtrtprsnt, cli.cbotrcinnt
                WHERE crtrtprsnt.hspt_cd = #{item.hspt_cd}
                  AND crtrtprsnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND crtrtprsnt.pid = #{item.pid}
                  AND cbotrcinnt.hspt_cd = #{item.hspt_cd}
                  AND cbotrcinnt.rcpn_sqno = #{item.rcpn_sqno}
                  AND cbotrcinnt.pid = #{item.pid}
            </if>
        </foreach>
    </update>

<!--    처방 수정       -->
    <update id="updatePtPrsc" parameterType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        <if test="updateList != null and updateList.size != 0">
            <foreach collection="updateList" item="item" separator=";">
                <!-- 기본 처방 -->
                <if test='item.prsc_clsf_cd == "A1" or item.prsc_clsf_cd == "A2" or item.prsc_clsf_cd == "A3"'>
                    UPDATE cli.crbasprsnt
                    SET crbasprsnt.prsc_nm = #{item.prsc_nm},
                        crbasprsnt.sort_sqno = #{item.row},
                        crbasprsnt.cmpt_yn = #{item.cmpt_yn},
                        crbasprsnt.prsc_memo = #{item.prsc_memo},
                        crbasprsnt.jx999 = #{item.jx999},
                        crbasprsnt.dc_yn = #{item.dc_yn}
                    <if test='item.dc_yn == "Y"'>
                        , crbasprsnt.dc_drcn_dr_id = #{item.usid},
                        crbasprsnt.dc_drcn_dt = #{item.dateTime},
                        crbasprsnt.dc_resn = #{item.dc_resn},
                        crbasprsnt.dc_resn_cd =#{item.dc_resn_cd}
                    </if>
                    WHERE crbasprsnt.hspt_cd = #{item.hspt_cd}
                      AND crbasprsnt.rcpn_sqno = #{item.rcpn_sqno}
                      AND crbasprsnt.prsc_sqno = #{item.prsc_sqno}
                </if>
                <!-- 약주사 처방 -->
                <if test='item.prsc_clsf_cd == "B1" or item.prsc_clsf_cd == "B2" or item.prsc_clsf_cd == "B3" or item.prsc_clsf_cd == "B4"'>
                    UPDATE cli.crdrinprnt
                    SET crdrinprnt.prsc_nm = #{item.prsc_nm},
                        crdrinprnt.sort_sqno = #{item.row},
                        crdrinprnt.dosg_1 = #{item.dosg_1},
                        crdrinprnt.totl_vol = #{item.totl_vol},
                        crdrinprnt.notm = #{item.notm},
                        crdrinprnt.nody = #{item.nody},
                        crdrinprnt.iotm_cd = #{item.iotm_cd},
                        crdrinprnt.mix_yn = #{item.mix_yn},
                        crdrinprnt.mix_no = #{item.mix_no},
                        crdrinprnt.hsin_hsot_dvcd = #{item.hsin_hsot_dvcd},
                        crdrinprnt.hsin_prsc_resn_cd = #{item.hsin_prsc_resn_cd},
                        crdrinprnt.cmpt_yn = #{item.cmpt_yn},
                        crdrinprnt.prsc_memo = #{item.prsc_memo},
                        crdrinprnt.jx999 = #{item.jx999},
                        crdrinprnt.dc_yn = #{item.dc_yn}
                    <if test='item.dc_yn == "Y"'>
                        , crdrinprnt.dc_drcn_dr_id = #{item.usid},
                        crdrinprnt.dc_drcn_dt = #{item.dateTime},
                        crdrinprnt.dc_resn = #{item.dc_resn},
                        crdrinprnt.dc_resn_cd =#{item.dc_resn_cd}
                    </if>
                    WHERE crdrinprnt.hspt_cd = #{item.hspt_cd}
                      AND crdrinprnt.rcpn_sqno = #{item.rcpn_sqno}
                      AND crdrinprnt.prsc_sqno = #{item.prsc_sqno}
                </if>
                <!-- 검사 처방 -->
                <if test='item.prsc_clsf_cd == "C1" or item.prsc_clsf_cd == "C2" or item.prsc_clsf_cd == "C3"'>
                    UPDATE cli.crexmprsnt
                    SET crexmprsnt.prsc_nm = #{item.prsc_nm},
                        crexmprsnt.sort_sqno = #{item.row},
                        crexmprsnt.cmpt_yn = #{item.cmpt_yn},
                        crexmprsnt.prsc_memo = #{item.prsc_memo},
                        crexmprsnt.jx999 = #{item.jx999},
                        crexmprsnt.dc_yn = #{item.dc_yn},
                    <if test='item.dc_yn == "Y"'>
                        crexmprsnt.dc_drcn_dr_id = #{item.usid},
                        crexmprsnt.dc_drcn_dt = #{item.dateTime},
                        crexmprsnt.dc_resn = #{item.dc_resn},
                        crexmprsnt.dc_resn_cd =#{item.dc_resn_cd},
                    </if>
                        crexmprsnt.spcm_cd_1, = #{item.spcm_cd_1}
                    WHERE crexmprsnt.hspt_cd = #{item.hspt_cd}
                      AND crexmprsnt.rcpn_sqno = #{item.rcpn_sqno}
                      AND crexmprsnt.prsc_sqno = #{item.prsc_sqno}
                </if>
                <!-- 처치 처방 -->
                <if test='item.prsc_clsf_cd == "D" or item.prsc_clsf_cd == "D1" or item.prsc_clsf_cd == "D2" or item.prsc_clsf_cd == "D3" or item.prsc_clsf_cd == "D4" or item.prsc_clsf_cd == "D5"'>
                    UPDATE cli.crtrtprsnt
                    SET crtrtprsnt.prsc_nm = #{item.prsc_nm},
                        crtrtprsnt.sort_sqno = #{item.row},
                        crtrtprsnt.cmpt_yn = #{item.cmpt_yn},
                        crtrtprsnt.prsc_memo = #{item.prsc_memo},
                        crtrtprsnt.jx999 = #{item.jx999},
                        crtrtprsnt.dc_yn = #{item.dc_yn},
                    <if test='item.dc_yn == "Y"'>
                        crtrtprsnt.dc_drcn_dr_id = #{item.usid},
                        crtrtprsnt.dc_drcn_dt = #{item.dateTime},
                        crtrtprsnt.dc_resn = #{item.dc_resn},
                        crtrtprsnt.dc_resn_cd =#{item.dc_resn_cd},
                    </if>
                        crtrtprsnt.qty = #{item.dosg_1},
                        crtrtprsnt.notm = #{item.notm}
                    WHERE crtrtprsnt.hspt_cd = #{item.hspt_cd}
                      AND crtrtprsnt.rcpn_sqno = #{item.rcpn_sqno}
                      AND crtrtprsnt.prsc_sqno = #{item.prsc_sqno}
                </if>
            </foreach>
        </if>
    </update>

<!--    의약분업예외 목록 조회        -->
    <select id="excpList" resultType="java.util.HashMap">
        SELECT czcomcodmt.cmcd_cd As value,
               czcomcodmt.cmcd_nm As text
        FROM cli.czcomcodmt
        WHERE czcomcodmt.hspt_cd = #{hspt_cd}
          AND czcomcodmt.cmcd_clsf_cd = 'CZ2001'
        ORDER BY czcomcodmt.cmcd_cd
    </select>

<!--    용법 목록 조회        -->
    <select id="iotmList" resultType="java.util.HashMap">
        SELECT iotm_cd As value,
               iotm_nm As text,
               prsc_clsf_cd,
               tkng_notm As notm
        FROM cli.csiotinfmt
        WHERE
<!--        hspt_cd = #{hspt_cd}-->
<!--          AND -->
        use_yn = 'Y'
        ORDER BY iotm_cd
    </select>
<!--    ==========================================================================================================================================================-->

</mapper>
