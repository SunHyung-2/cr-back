<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.cra.cra1000.mapper.CRA1000Mapper">

    <select id="testData" resultType="com.amaranth10.cr.cra.cra1000.model.CRA1000Model">
        select pid, pt_nm, dobr from cli_dev.cbptbainmt
    </select>

<!--    CLRS0101 환자현황 ==========================================================================================================================================-->
<!--    환자현황 대기 환자수 조회  -->
    <select id="patientCount" resultType="com.amaranth10.cr.cra.cra1000.model.Patient">
        SELECT COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd IN ('R', 'M') THEN 1 END) AS Rcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd = 'W' THEN 1 END) AS Wcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd = 'V' THEN 1 END) AS Vcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd IN ('T', 'D') THEN 1 END) AS Dcount,
               COUNT(CASE WHEN cbotrcinnt.rcpn_stat_cd LIKE '%' THEN 1 END) AS Acount
          FROM cli_dev.cbotrcinnt
         WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
           AND cbotrcinnt.mdcr_date = #{mdcr_date}
           AND cbotrcinnt.mdcr_dr_id like #{mdcr_dr_id}
           AND cbotrcinnt.rcpn_stat_cd != 'C'
    </select>

<!--    환자현황 대기 리스트-->
    <select id="patientList" resultType="com.amaranth10.cr.cra.cra1000.model.Patient">
        SELECT cbptbainmt.pid,
               cbptbainmt.pt_nm,
               cbotrcinnt.mdcr_date,
               cli_dev.fn_get_commname(cbotrcinnt.mdcr_date, '접수상태', cbotrcinnt.rcpn_stat_cd) as rcpn_stat_cd,
               cbotrcinnt.mdcr_hm,
               cbotrcinnt.rcpn_sqno,
               cbotrcinnt.rcpn_stat_cd as call_patient
        FROM cli_dev.cbptbainmt, cli_dev.cbotrcinnt
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbotrcinnt.hspt_cd = cbptbainmt.hspt_cd
          AND cbotrcinnt.pid = cbptbainmt.pid
          AND cbotrcinnt.mdcr_date = #{mdcr_date}
          AND cbotrcinnt.rcpn_stat_cd IN (
        <foreach collection="rcpn_stat_list" item="item" separator=",">
            #{item}
        </foreach>)
          AND cbotrcinnt.mdcr_dr_id like #{mdcr_dr_id}
          AND cbotrcinnt.rcpn_stat_cd != 'C'
          AND cbptbainmt.del_yn = 'N'
        ORDER BY cbotrcinnt.mdcr_hm
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0102 환자정보 ==========================================================================================================================================-->
<!--    환자정보, 접수정보 조회      -->
    <select id="patientDetails" resultType="com.amaranth10.cr.cra.cra1000.model.Patient">
        SELECT cbptbainmt.pid,
               cbptbainmt.pt_nm,
               cbptbainmt.pt_frrn,
               cbptbainmt.pt_srrn,
               cbptbainmt.dobr,
               cbptbainmt.sex_cd As sex,
               cbptbainmt.clph_no,
               cbptbainmt.pstl_no,
               cbptbainmt.basc_addr,
               cbptbainmt.detl_addr,
               cbptbainmt.vip_pt_yn,
               cbptbainmt.cncn_pt_yn,
               cbptbainmt.priv_pt_yn,
               cbotrcinnt.rcpn_sqno,
               cbotrcinnt.mdcr_date,
               cbotrcinnt.mdcr_hm,
               cbotrcinnt.mddp_cd,
               cbotrcinnt.mdcr_dr_id,
               cbotrcinnt.fvnr_dvcd,
<!--        cli_dev.fn_get_commname(cbotrcinnt.mdcr_date, '접수상태', cbotrcinnt.fvnr_dvcd) as fvnr_dvcd,-->

        cbotrcinnt.insn_tycd,
<!--        cli_dev.fn_get_commname(cbotrcinnt.mdcr_date, '접수상태', cbotrcinnt.insn_tycd) as rcpn_stat_cd,-->

        cbotrcinnt.type_asst_cd,
<!--        cli_dev.fn_get_commname(cbotrcinnt.mdcr_date, '접수상태', cbotrcinnt.type_asst_cd) as rcpn_stat_cd,-->

               cbotrcinnt.rcpn_memo,
               cbotrcinnt.cmhs_path_cd,
<!--        cli_dev.fn_get_commname(cbotrcinnt.mdcr_date, 'C4004', cbotrcinnt.cmhs_path_cd) as rcpn_stat_cd,-->
               cbptmeinnt1.memo_dvsn As clr_dvsn,
               cbptmeinnt1.memo_cnts As clr_cnts,
               cbptmeinnt2.memo_dvsn As pat_dvsn,
               cbptmeinnt2.memo_cnts As pat_cnts
        FROM cli_dev.cbptbainmt, cli_dev.cbotrcinnt
        LEFT OUTER JOIN cli_dev.cbptmeinnt As cbptmeinnt1
          ON cbptmeinnt1.hspt_cd = #{hspt_cd}
         AND cbptmeinnt1.pid = #{pid}
         AND cbptmeinnt1.memo_dvsn = 'CLR'
        LEFT OUTER JOIN cli_dev.cbptmeinnt As cbptmeinnt2
          ON cbptmeinnt2.hspt_cd = #{hspt_cd}
         AND cbptmeinnt2.pid = #{pid}
         AND cbptmeinnt2.memo_dvsn = 'PAT'
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
          AND cbptbainmt.hspt_cd = cbotrcinnt.hspt_cd
          AND cbotrcinnt.pid = #{pid}
          AND cbptbainmt.pid = cbotrcinnt.pid
          AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
    </select>

<!--    관심환자 여부 수정     -->
    <update id="updatePtCncn">
        UPDATE cli_dev.cbptbainmt
           SET cbptbainmt.cncn_pt_yn = #{cncn_pt_yn}
        WHERE cbptbainmt.hspt_cd = #{hspt_cd}
          AND cbptbainmt.pid = #{pid}
    </update>

<!--    접수메모 저장 및 수정    -->
    <update id="patientRcpnMemo">
        UPDATE cli_dev.cbotrcinnt
        SET cbotrcinnt.rcpn_memo = #{rcpn_memo}
        WHERE cbotrcinnt.hspt_cd = #{hspt_cd}
        AND cbotrcinnt.pid = #{pid}
        AND cbotrcinnt.rcpn_sqno = #{rcpn_sqno}
    </update>

<!--    진료메모 & 환자메모 저장      -->

<!--    진료메모 & 환자메모 수정      -->

<!--    보험 구분 목록   -->
<!--    초재진 구분 목록   -->
<!--    부서 목록    -->
<!--    외래경로 목록     -->
<!--    내원목적 목록     -->

<!--    ==========================================================================================================================================================-->


<!--    CLRS0103 신체사정정보 ==========================================================================================================================================-->
<!--    ==========================================================================================================================================================-->


<!--    CLRS0104 검사결과 ==========================================================================================================================================-->
<!--    ==========================================================================================================================================================-->


<!--    CLRS0105 경과기록 ==========================================================================================================================================-->
<!--    ==========================================================================================================================================================-->


<!--    CLRS0106 처방조회 ==========================================================================================================================================-->
<!--    SLIP 목록     -->
    <select id="slipList" resultType="com.amaranth10.cr.cra.cra1000.model.Slip">
        SELECT crslipclmt.slip_cd,
               crslipclmt.slip_nm,
               crslipclmt.clsf_dvcd
        FROM cli_dev.crslipclmt
        WHERE crslipclmt.hspt_cd = #{hspt_cd}
        ORDER BY crslipclmt.slip_cd
    </select>

<!--    SLIP 수가 항목      -->
    <select id="slipPrscList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crprsccdmt.prsc_cd,
               crprsccdmt.prsc_nm
        FROM cli_dev.crprsccdmt
        WHERE crprsccdmt.hspt_cd = #{hspt_cd}
        AND crprsccdmt.slip_cd = #{slip_cd}
        AND crprsccdmt.prsc_psbl_yn = "Y"
        ORDER BY crprsccdmt.prsc_nm
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0107 진단 ==========================================================================================================================================-->
<!--    진단 검색       -->
    <select id="dgnsMList" resultType="com.amaranth10.cr.cra.cra1000.model.Diagnosis">
        SELECT crkcddgcmt.dgns_cd,
               crkcddgcmt.dgns_hnm As dgns_nm,
               crkcddgcmt.dgns_enm,
               crkcddgcmt.spcf_rgno
        FROM cli_dev.crkcddgcmt
        WHERE crkcddgcmt.hspt_cd = #{hspt_cd}
          and (crkcddgcmt.dgns_cd LIKE CONCAT("%", #{keyword}, "%")
            OR crkcddgcmt.dgns_enm LIKE CONCAT("%", #{keyword}, "%")
            OR crkcddgcmt.dgns_hnm LIKE CONCAT("%", #{keyword}, "%"))
    </select>

<!--    진단 내역       -->
    <select id="dgnsList" resultType="com.amaranth10.cr.cra.cra1000.model.Diagnosis">
        SELECT crptdgnsnt.dgns_sqno,
               crptdgnsnt.dgns_cd,
               crptdgnsnt.dgns_nm,
               crptdgnsnt.dvsn,
               IF(crptdgnsnt.ro_yn = "Y", "True", "False") As ro_yn,
               crptdgnsnt.site_dvcd,
               crptdgnsnt.spcf_rgno
        FROM cli_dev.crptdgnsnt
        WHERE crptdgnsnt.hspt_cd = #{hspt_cd}
          AND crptdgnsnt.del_yn = "N"
          AND crptdgnsnt.rcpn_sqno = #{rcpn_sqno}
          AND crptdgnsnt.pid = #{pid}
        ORDER BY crptdgnsnt.sort_sqno
    </select>
<!--    ==========================================================================================================================================================-->


<!--    CLRS0108 처방 ==========================================================================================================================================-->
<!--    처방 검색       -->
    <select id="prscMList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crprsccdmt.prsc_cd,
               crprsccdmt.prsc_nm,
               crprsccdmt.prsc_clsf_cd,
               crprsccdmt.slip_cd,
               crprsccdmt.drug_injc_dvsn,
               crprsccdmt.iotm_cd,
               crprsccdmt.inpy_dvcd,
               crprsccdmt.basc_dosg As dosg_1,
               crprsccdmt.basc_notm As notm,
<!--        crprsccdmt.prsc_psbl_yn,-->
               crprsccdmt.basc_aomd_uncd,
               crprsccdmt.spcm_cd_1,
               crprsccdmt.spcm_ctnr_cd_1,
               crprsccdmt.hsot_prsc_yn As hsin_hsot_dvcd,
               crprsccdmt.spfm_excp_cd As hsin_prsc_resn_cd,
               crprsccdmt.ctnt_uncd As uncd,
               crprsccdmt.exmn_rslt_uncd
        FROM cli_dev.crprsccdmt
        WHERE crprsccdmt.hspt_cd = #{hspt_cd}
          AND crprsccdmt.prsc_psbl_yn = "Y"
          AND (crprsccdmt.prsc_cd LIKE CONCAT("%", #{keyword}, "%")
            OR crprsccdmt.prsc_nm LIKE CONCAT("%", #{keyword}, "%"))
    </select>

<!--    처방 내역       -->
    <select id="prscList" resultType="com.amaranth10.cr.cra.cra1000.model.Prescription">
        SELECT crdrinprnt.prsc_sqno,
                crdrinprnt.prsc_cd,
                crdrinprnt.prsc_nm,
                crdrinprnt.dosg_1,
                crdrinprnt.notm,
                crdrinprnt.nody,
                crdrinprnt.drug_injc_dvsn,
                crdrinprnt.iotm_cd,
                crdrinprnt.pwdr_yn,
                crdrinprnt.mix_no,
                crdrinprnt.prsc_pay_dvcd As inpy_dvcd,
                crdrinprnt.hsin_hsot_dvcd,
                crdrinprnt.hsin_prsc_resn_cd,
                crdrinprnt.cmpt_yn,
                crdrinprnt.prsc_memo,
                crdrinprnt.jx999,
                crdrinprnt.dc_yn,
                crdrinprnt.dc_resn_cd,
                crdrinprnt.dc_resn
        FROM cli_dev.crdrinprnt
        WHERE crdrinprnt.hspt_cd = #{hspt_cd}
          AND crdrinprnt.rcpn_sqno = #{rcpn_sqno}
          AND crdrinprnt.pid = #{pid}
        ORDER BY crdrinprnt.sort_sqno
    </select>
<!--    ==========================================================================================================================================================-->

</mapper>
