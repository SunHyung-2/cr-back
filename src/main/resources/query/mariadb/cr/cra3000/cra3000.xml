<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.cra.cra3000.mapper.CRA3000Mapper">
<!--    약속처방 목록     -->
    <select id="setList"  resultType="com.amaranth10.cr.cra.cra3000.model.SetPrsc">
        WITH  RECURSIVE CTE AS (
            SELECT hspt_cd,
                    set_prsc_usid,
                    set_prsc_sqno,
                    set_prsc_nm,
                    set_prsc_uprn_sqno,
                    CONVERT ("", VARCHAR(100)) AS depth
            FROM crsetprsmt
            WHERE set_prsc_sqno = 1
            UNION ALL
            SELECT A.hspt_cd,
                    A.set_prsc_usid,
                    A.set_prsc_sqno,
                    A.set_prsc_nm,
                    A.set_prsc_uprn_sqno,
        TRIM(CONCAT(depth, " > ", B.set_prsc_nm)) AS depth
            FROM crsetprsmt AS A
            INNER JOIN CTE AS B ON B.set_prsc_sqno = A.set_prsc_uprn_sqno
        )
        SELECT set_prsc_sqno,
                set_prsc_nm,
                set_prsc_uprn_sqno,
                RTRIM(TRIM(LEADING "> " FROM depth)) AS depth
        FROM CTE
        WHERE hspt_cd = #{hspt_cd}
          AND set_prsc_usid = #{usid}
        ORDER BY set_prsc_sqno
    </select>

<!--    약속처방 검색 목록      -->
    <select id="searchSetList" resultType="com.amaranth10.cr.cra.cra3000.model.SetPrsc">
        SELECT set_prsc_sqno,
               set_prsc_nm,
               set_prsc_uprn_sqno
        FROM crsetprsmt
        WHERE hspt_cd = #{hspt_cd}
          AND set_prsc_usid = #{usid}
          AND set_prsc_nm LIKE CONCAT ("%", #{keyword}, "%")
          AND set_prsc_sqno != 1
        ORDER BY set_prsc_sqno
    </select>

<!--    약속처방 진단 내역     -->
    <select id="setDgnsList" resultType="com.amaranth10.cr.cra.cra3000.model.Diagnosis">
        SELECT set_prsc_sqno,
               dgns_cd,
               dgns_nm,
               dgns_site_cd As site_dvcd,
               dgns_sqno
        FROM crsetdigdt
        WHERE set_prsc_sqno = #{set_cd}
        ORDER BY sort_sqno
    </select>

<!--    약속처방 처방 내역     -->
    <select id="setPrscList" resultType="com.amaranth10.cr.cra.cra3000.model.Prescription">
        SELECT set_prsc_sqno,
                prsc_cd,
                prsc_nm,
                mix_yn,
                mix_no,
                prsc_dosg1 As dosg_1,
                prsc_notm As notm,
                prsc_nody As nody,
                iotm_cd,
                prsc_pay_dvcd,
                hsin_hsot_dvcd,
                spfm_excp_resn_cd As hsin_prsc_resn_cd,
                prsc_sqno,
                prsc_clsf_cd
        FROM crsetprsdt
        WHERE set_prsc_sqno = #{set_cd}
        ORDER BY sort_sqno
    </select>

<!--    약속처방 삭제     -->
    <delete id="deleteSet">
        <if test='status != null and status == "del"'>
            <foreach collection="delList" item="item" separator=";">
                DELETE s, p, d
                  FROM crsetprsmt As s
                LEFT JOIN crsetprsdt As p
                       ON p.set_prsc_sqno = s.set_prsc_sqno
                      AND p.hspt_cd = #{hspt_cd}
                LEFT JOIN crsetdigdt As d
                       ON d.set_prsc_sqno = s.set_prsc_sqno
                      AND d.hspt_cd = #{hspt_cd}
                WHERE s.set_prsc_sqno = #{item}
                  AND s.hspt_cd = #{hspt_cd}
                  AND s.set_prsc_usid = #{usid}
            </foreach>
        </if>
        <if test='status != null and status == "upd"'>
            <if test='delDgns != null and delDgns.size != 0'>
                <foreach collection="delDgns" item="item" separator=";">
                    DELETE FROM crsetdigdt
                    WHERE set_prsc_sqno = #{set.set_prsc_sqno}
                      AND dgns_sqno = #{item.dgns_sqno}
                      AND hspt_cd = #{hspt_cd}
                </foreach>
            </if>
            <if test='delPrsc != null and delPrsc.size != 0'>
                <foreach collection="delPrsc" item="item" separator=";">
                    DELETE FROM crsetprsdt
                    WHERE set_prsc_sqno = #{set.set_prsc_sqno}
                      AND prsc_sqno = #{item.prsc_sqno}
                      AND hspt_cd = #{hspt_cd}
                </foreach>
            </if>
        </if>
    </delete>

<!--    약속처방 저장      -->
    <insert id="saveSet" parameterType="java.util.Objects">
        <if test='set.set_prsc_sqno == 0'>
            INSERT INTO crsetprsmt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt, set_prsc_usid, set_prsc_uprn_sqno, set_prsc_nm)
            VALUES (
                #{hspt_cd},
                #{frst_rgst_usid},
                #{frst_rgdt},
                #{last_updt_usid},
                #{last_uddt},
                #{usid},
                #{set.set_prsc_uprn_sqno},
                #{set.set_prsc_nm}
            );
        </if>
        <if test='dgnsList != null and dgnsList.size != 0'>
            <foreach collection="dgnsList" item="item" separator=";">
            INSERT INTO crsetdigdt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                set_prsc_sqno, dgns_sqno, dgns_cd, dgns_nm, dgns_site_cd, sort_sqno)
            SELECT
                #{hspt_cd},
                #{frst_rgst_usid},
                #{frst_rgdt},
                #{last_updt_usid},
                #{last_uddt},
                <choose>
                    <when test='set.set_prsc_sqno == 0'>
                        (SELECT AUTO_INCREMENT - 1
                        FROM information_schema.tables
                        WHERE table_name = 'crsetprsmt'
                        AND table_schema = DATABASE( )),
                    </when>
                    <otherwise>
                        #{set.set_prsc_sqno},
                    </otherwise>
                </choose>
                <choose>
                    <when test='item.dgns_sqno == null'>
                        IFNULL(MAX(crsetdigdt.dgns_sqno) + 1, 1),
                    </when>
                    <otherwise>
                        #{item.dgns_sqno},
                    </otherwise>
                </choose>
                #{item.dgns_cd},
                #{item.dgns_nm},
                #{item.site_dvcd},
                #{item.row}
            FROM crsetdigdt
            WHERE set_prsc_sqno =
            <choose>
                <when test='set.set_prsc_sqno == 0'>
                    (SELECT AUTO_INCREMENT - 1
                    FROM information_schema.tables
                    WHERE table_name = 'crsetprsmt'
                    AND table_schema = DATABASE( ))
                </when>
                <otherwise>
                    #{set.set_prsc_sqno}
                </otherwise>
            </choose>
            ON DUPLICATE KEY UPDATE
                last_updt_usid = #{last_updt_usid},
                last_uddt = #{last_uddt},
                dgns_nm = #{item.dgns_nm},
                dgns_site_cd = #{item.site_dvcd},
                sort_sqno = #{item.row}
            </foreach>;
        </if>
        <if test='prscList != null and prscList.size != 0'>
            <foreach collection="prscList" item="item" separator=";">
            INSERT INTO crsetprsdt
                (hspt_cd, frst_rgst_usid, frst_rgdt, last_updt_usid, last_uddt,
                set_prsc_sqno, prsc_sqno, prsc_cd, prsc_nm, prsc_clsf_cd, prsc_dosg1, prsc_notm, prsc_nody,
                iotm_cd, hsin_hsot_dvcd, spfm_excp_resn_cd,
                mix_yn, mix_no, prsc_qty, prsc_pay_dvcd, sort_sqno)
            SELECT
                #{hspt_cd},
                #{frst_rgst_usid},
                #{frst_rgdt},
                #{last_updt_usid},
                #{last_uddt},
                <choose>
                    <when test='set.set_prsc_sqno == 0'>
                        (SELECT AUTO_INCREMENT - 1
                        FROM information_schema.tables
                        WHERE table_name = 'crsetprsmt'
                        AND table_schema = DATABASE( )),
                    </when>
                    <otherwise>
                        #{set.set_prsc_sqno},
                    </otherwise>
                </choose>
                <choose>
                    <when test='item.prsc_sqno == null'>
                        IFNULL(MAX(crsetprsdt.prsc_sqno) + 1, 1),
                    </when>
                    <otherwise>
                        #{item.prsc_sqno},
                    </otherwise>
                </choose>
                #{item.prsc_cd},
                #{item.prsc_nm},
                #{item.prsc_clsf_cd},
                #{item.dosg_1},
                #{item.notm},
                #{item.nody},
                #{item.iotm_cd},
                #{item.hsin_hsot_dvcd},
                #{item.hsin_prsc_resn_cd},
                #{item.mix_yn},
                #{item.mix_no},
                #{item.totl_vol},
                #{item.prsc_pay_dvcd},
                #{item.row}
                FROM crsetprsdt
                WHERE set_prsc_sqno =
                <choose>
                    <when test='set.set_prsc_sqno == 0'>
                        (SELECT AUTO_INCREMENT - 1
                        FROM information_schema.tables
                        WHERE table_name = 'crsetprsmt'
                        AND table_schema = DATABASE( ))
                    </when>
                    <otherwise>
                        #{set.set_prsc_sqno}
                    </otherwise>
                </choose>
                ON DUPLICATE KEY UPDATE
                    last_updt_usid = #{last_updt_usid},
                    last_uddt = #{last_uddt},
                    prsc_nm = #{item.prsc_nm},
                    prsc_dosg1 = #{item.dosg_1},
                    prsc_notm = #{item.notm},
                    prsc_nody = #{item.nody},
                    iotm_cd = #{item.iotm_cd},
                    hsin_hsot_dvcd = #{item.hsin_hsot_dvcd},
                    spfm_excp_resn_cd = #{item.hsin_prsc_resn_cd},
                    mix_yn = #{item.mix_yn},
                    mix_no = #{item.mix_no},
                    prsc_qty = #{item.totl_vol},
                    prsc_pay_dvcd = #{item.prsc_pay_dvcd},
                    sort_sqno = #{item.row}
            </foreach>;
        </if>
    </insert>

<!--    약속처방 수정     -->
    <update id="updateSet" parameterType="java.util.Objects">
        UPDATE crsetprsmt
        SET last_updt_usid = #{last_updt_usid},
            last_uddt = #{last_uddt},
            set_prsc_nm = #{set.set_prsc_nm},
            set_prsc_uprn_sqno = #{set.set_prsc_uprn_sqno}
        WHERE hspt_cd = #{hspt_cd}
          AND set_prsc_sqno = #{set.set_prsc_sqno};
<!--        <if test='updDgns != null and updDgns.size != 0'>-->
<!--            <foreach collection="updDgns" item="item" separator=";">-->
<!--                UPDATE crsetdigdt-->
<!--                SET last_updt_usid = #{last_updt_usid},-->
<!--                    last_uddt = #{last_uddt},-->
<!--                    dgns_nm = #{item.dgns_nm},-->
<!--                    dgns_site_cd = #{item.site_dvcd},-->
<!--                    sort_sqno = #{item.row}-->
<!--                WHERE crsetdigdt.hspt_cd = #{hspt_cd}-->
<!--                  AND crsetdigdt.set_prsc_sqno = #{set.set_prsc_sqno}-->
<!--                  AND crsetdigdt.dgns_sqno = #{item.dgns_sqno}-->
<!--            </foreach>;-->
<!--        </if>-->
<!--        <if test='updPrsc != null and updPrsc.size != 0'>-->
<!--            <foreach collection="updPrsc" item="item" separator=";">-->
<!--                UPDATE crsetprsdt-->
<!--                SET last_updt_usid = #{last_updt_usid},-->
<!--                    last_uddt = #{last_uddt},-->
<!--                    prsc_nm = #{item.prsc_nm},-->
<!--                    prsc_dosg1 = #{item.dosg_1},-->
<!--                    prsc_notm = #{item.notm},-->
<!--                    prsc_nody = #{item.nody},-->
<!--                    iotm_cd = #{item.iotm_cd},-->
<!--                    hsin_hsot_dvcd = #{item.hsin_hsot_dvcd},-->
<!--                    spfm_excp_resn_cd = #{item.hsin_prsc_resn_cd},-->
<!--                    mix_yn = #{item.mix_yn},-->
<!--                    mix_no = #{item.mix_no},-->
<!--                    prsc_qty = #{item.totl_vol},-->
<!--                    prsc_pay_dvcd = #{item.prsc_pay_dvcd},-->
<!--                    sort_sqno = #{item.row}-->
<!--                WHERE crsetprsdt.hspt_cd = #{hspt_cd}-->
<!--                  AND crsetprsdt.set_prsc_sqno = #{set.set_prsc_sqno}-->
<!--                  AND crsetprsdt.prsc_sqno = #{item.prsc_sqno}-->
<!--            </foreach>;-->
<!--        </if>-->
    </update>
</mapper>