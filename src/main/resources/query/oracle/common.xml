<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.amaranth10.cr.mapper.CommonMapper">

	<select id="selectUserName" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT emp_name
		FROM ${DB_NEOS}.t_co_emp_multi
		WHERE(emp_seq = (SELECT emp_seq 
			FROM ${DB_NEOS}.t_co_emp 
			WHERE login_id = #{login_id})
				<choose>
					<when test="langCode != null">
						AND lang_code = #{langCode}
					</when>
					<otherwise>
						AND lang_code = 'kr'
					</otherwise>
				</choose> 
				)		
	</select>

	<select id="selectCompList" parameterType="java.util.Map" resultType="java.util.Map">
   			SELECT  
			     oc.group_seq as grp_seq
			    ,oc.gbn_org as gbn_org
			    ,oc.comp_seq as comp_seq
			    ,${DB_NEOS}.FN_GetMultiLang(#{langCode},ccm.comp_name_multi) as comp_name
			    ,oc.biz_seq as biz_seq
			    ,${DB_NEOS}.FN_GetMultiLang(#{langCode},cbm.biz_name_multi) as biz_name
			    ,oc.dept_seq as dept_seq
			    ,${DB_NEOS}.FN_GetMultiLang(#{langCode},cdm.dept_name_multi) as dept_name
			    ,oc.parent_seq as parent_seq
			    ,oc.level as level
			    ,oc.order_num as "order"
			    ,oc.path
			    ,(CASE WHEN oc.gbn_org = 'c' AND cb.display_yn = 'Y' THEN CONCAT(ccm.comp_name, '|', CONCAT(cbm.biz_name, '|', cdm.path_name))
			        WHEN cb.display_yn = 'N' THEN CONCAT(ccm.comp_name, '|', cdm.path_name) END) as path_name
			    ,a.member as member
			    ,cc.comp_cd as compCd
			FROM ${DB_NEOS}.v_org_chart_admin oc
			LEFT JOIN
			(
			    SELECT A.path, IFNULL(SUM(B.cnt), 0) AS member
			    FROM ${DB_NEOS}.v_org_chart_admin A
			    LEFT JOIN
			    (
			        SELECT CASE WHEN cb.display_yn = 'Y' THEN CONCAT(cb.comp_seq, '|', CONCAT(cb.biz_seq, '|', cd.path))
			            ELSE CONCAT(cb.comp_seq, '|', cd.path) END as path, COUNT(ed.emp_seq) cnt
			        FROM ${DB_NEOS}.t_co_dept cd, ${DB_NEOS}.t_co_emp_dept ed, ${DB_NEOS}.t_co_biz cb
			        WHERE ed.group_seq = #{groupSeq}
			        <if test="compSeqList != null">
				    	AND ed.comp_seq IN (${compSeqList})
				    </if>
			            AND ed.group_seq = cd.group_seq
			            AND ed.dept_seq = cd.dept_seq
			            AND ed.group_seq = cb.group_seq
			            AND ed.biz_seq = cb.biz_seq
			            AND ed.use_yn = 'Y'
			            AND cd.use_yn = 'Y'
			            AND cb.use_yn = 'Y'
			        GROUP BY cd.path
			    ) B
			    ON B.path like concat(A.path,'%')
			    WHERE A.group_seq =  #{groupSeq}
			    <if test="compSeqList != null">
			    and A.comp_seq IN (${compSeqList})
			    </if>
			    <if test='compSeq != null and compSeq != ""'>
				and A.comp_seq = #{compSeq}
				</if>
			    GROUP BY A.path  
			) a
			ON oc.path = a.path
			LEFT JOIN ${DB_NEOS}.t_co_comp cc
			ON      oc.comp_seq= cc.comp_seq
			LEFT JOIN ${DB_NEOS}.t_co_biz cb
			ON      oc.biz_seq = cb.biz_seq
			LEFT JOIN ${DB_NEOS}.v_t_co_comp_multi ccm
			ON      oc.comp_seq = ccm.comp_seq
			LEFT JOIN ${DB_NEOS}.v_t_co_biz_multi cbm
			ON      oc.biz_seq = cbm.biz_seq
			LEFT JOIN ${DB_NEOS}.v_t_co_dept_multi cdm
			ON      oc.dept_seq = cdm.dept_seq          
			WHERE	oc.group_seq =  #{groupSeq}
			<if test="compSeqList != null">
				and oc.comp_seq IN (${compSeqList})
			</if>
			<if test='compSeq != null and compSeq != ""'>
				and oc.comp_seq = #{compSeq}
			</if>
			<if test='gbnOrgList != null'>
				and oc.gbn_org IN (${gbnOrgList})
			</if>
			<if test='gubun != null and gubun != ""'>
				and oc.use_yn = "Y"
				<if test='gubun == "grouping"'>
				and oc.comp_seq IN (select comp_seq from ${DB_NEOS}.t_co_groupping_comp where groupping_seq = #{grouppingSeq})
				</if>
				<if test='gubun == "notGrouping"'>
				and oc.comp_seq NOT IN (select comp_seq from ${DB_NEOS}.t_co_groupping_comp where groupping_seq = #{grouppingSeq})
				</if>
			</if>
			
			ORDER BY oc.order_num , oc.comp_seq
	</select>
	
	<select id="devLogin" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT 
		  a.group_seq as groupSeq
		, a.login_id AS loginId
		, a.emp_seq AS empSeq
		, ${DB_NEOS}.FN_GetMultiLang(a.native_lang_code, b.emp_name_multi) AS empName
		, a.native_lang_code AS langCode
		, 'USER' AS userSe
		, IF(IF( IFNULL(d.email_domain,'') = '', IFNULL(a.out_mail,''),a.email_addr )='',a.email_addr,IF( IFNULL(d.email_domain,'') = '',IFNULL(a.out_mail,''), a.email_addr )) AS emailAdd
		, IF(IFNULL(d.email_domain,'') = '', IFNULL(a.out_domain,''),d.email_domain ) as emailDomain
		, d.ea_type as eaType
		, a.pic_file_id AS picFileId
		, '' AS clientIp
		, c.comp_seq AS compSeq
		, ${DB_NEOS}.FN_GetMultiLang(a.native_lang_code, cm.comp_name_multi) AS compName
		, c.biz_seq as bizSeq
		, ${DB_NEOS}.FN_GetMultiLang(a.native_lang_code, bm.biz_name_multi) AS bizName
		, c.dept_seq AS deptSeq
		, ${DB_NEOS}.FN_GetMultiLang(a.native_lang_code, dm.dept_name_multi) AS deptName
		, c.position_code AS positionCode
		, ${DB_NEOS}.get_emp_duty_position_name(a.group_seq,c.comp_seq,c.position_code,'POSITION',a.native_lang_code) as positionName
		, c.duty_code AS dutyCode
		, ${DB_NEOS}.get_emp_duty_position_name(a.group_seq,c.comp_seq,c.duty_code,'DUTY',a.native_lang_code) as dutyName
		, ${DB_NEOS}.get_auth_group_concat(c.comp_seq, c.dept_seq, a.emp_seq,c.DUTY_CODE, c.POSITION_CODE) AS authorCode
		, e.erp_comp_seq AS erpCompSeq
		, e.erp_biz_seq AS erpBizSeq
		, e.erp_dept_seq as erpDeptSeq
		, e.erp_emp_seq as erpEmpSeq
		, ${DB_NEOS}.get_dept_pathNm('|',c.dept_seq,c.group_seq,a.native_lang_code) as deptPathNm
		, if(ifnull(d.comp_mail_url,'')='',g.mail_url,d.comp_mail_url) compMailUrl	
		FROM ${DB_NEOS}.t_co_group g, ${DB_NEOS}.t_co_emp a,
		${DB_NEOS}.v_t_co_emp_multi b, ${DB_NEOS}.t_co_emp_dept c,
		${DB_NEOS}.t_co_comp d, ${DB_NEOS}.t_co_emp_comp e, ${DB_NEOS}.t_co_dept
		tcd, ${DB_NEOS}.v_t_co_comp_multi cm, ${DB_NEOS}.v_t_co_biz_multi bm , ${DB_NEOS}.v_t_co_dept_multi dm
		WHERE a.login_id = #{loginId}
		AND a.group_seq = IF( #{groupSeq} = 'null', a.group_seq, #{groupSeq} )
		AND g.group_seq = a.group_seq
		AND a.emp_seq = b.emp_seq
		AND a.emp_seq = c.emp_seq
		AND c.comp_seq = d.comp_seq
		AND c.dept_seq = tcd.dept_seq
		AND c.comp_seq = cm.comp_seq
		AND c.biz_seq = bm.biz_seq
		AND c.dept_seq = dm.dept_seq
		<if test='compSeq != "" and compSeq != null'>
			AND d.comp_seq = #{compSeq}
		</if>
		AND e.emp_seq = c.emp_seq
		AND e.comp_seq = d.comp_seq
		AND e.work_status IN ('999','004')
		AND c.main_dept_yn = 'Y'
		AND a.use_yn = 'Y'
		AND b.use_yn = 'Y'
		AND c.use_yn = 'Y'
		AND d.use_yn = 'Y'
		AND e.use_yn = 'Y'
		AND tcd.use_yn = 'Y'
		AND a.license_check_yn != '3'
		ORDER BY CASE WHEN e.COMP_SEQ = a.main_comp_seq THEN 0 ELSE 1 END
		LIMIT 1
	</select>
</mapper>